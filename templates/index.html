<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Darkline Private Chat</title>
<style>
body { background-color: #121212; color: white; font-family: monospace; }
#chat { height: 400px; overflow-y: scroll; border: 1px solid #333; padding: 10px; margin-bottom: 10px;}
input, button { padding: 10px; margin-top: 5px; background: #1f1f1f; color: white; border: none; }
button { background: #6200ee; cursor: pointer; }
</style>
</head>
<body>
<h2>Darkline Private Chat</h2>

<label>Username:</label>
<input type="text" id="username"><br>
<label>Password:</label>
<input type="password" id="password"><br>
<button onclick="register()">Register</button>
<button onclick="login()">Login</button>

<div id="chat"></div>
<input type="text" id="target" placeholder="Send to username">
<input type="text" id="message" placeholder="Message">
<button onclick="sendMessage()">Send</button>

<script>
let token = null;
let ws = null;

function register() {
    let username = document.getElementById("username").value;
    let password = document.getElementById("password").value;
    fetch("/register", {
        method: "POST",
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `username=${username}&password=${password}`
    }).then(res => res.json()).then(data => alert(data.msg));
}

function login() {
    let username = document.getElementById("username").value;
    let password = document.getElementById("password").value;
    fetch("/token", {
        method: "POST",
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `username=${username}&password=${password}`
    }).then(res => res.json()).then(data => {
        token = data.access_token;
        ws = new WebSocket(`wss://${window.location.host}/ws/${username}?token=${token}`);
        ws.onmessage = function(event){
            let chat = document.getElementById("chat");
            chat.innerHTML += "<div>"+event.data+"</div>";
            chat.scrollTop = chat.scrollHeight;
        };
    });
}

function sendMessage() {
    let target = document.getElementById("target").value;
    let msg = document.getElementById("message").value;
    if(ws) ws.send(`${target}:${msg}`);
    document.getElementById("message").value = "";
}
</script>
</body>
</html>
